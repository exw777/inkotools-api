# Inkotel Scripts (Python)
> Скрипты для упрощения работы с коммутаторами в сети ИНКО

На данный момент реализовано:
- быстрое подключение к коммутаторам в интерактивном режиме
- отправка произвольных команд с получением результата их выполнения
- локальная база данных коммутаторов с поиском по модели и расположению

## Установка

### Клонируем репозиторий

```shell
$ git clone https://git.truman.network/inkotel/scripts-python.git
$ cd scripts-python
```

### [ОПЦИОНАЛЬНО] создаем виртуальное окружение

```shell
$ python -m venv .venv
$ source .venv/bin/activate
```

### Устанавливаем зависимости

```shell
$ pip install -r requirements.txt
```

## Настройка

Файлы конфигурации находятся в директории `config`. Используется формат `YAML`.

### Логины и пароли

Файл `secrets.yml` содержит пароли для доступа к коммутаторам. Можно использовать как образец `config/secrets.sample.yml`, переименовать, и вписать свои данные.

- `admin_profile` - профиль для узловых коммутаторов
- `user_profile` - профиль для коммутаторов уровня доступа

```yaml
---
secrets:
  admin_profile:
    login: admin
    password: adminpassword
  user_profile:
    login: user
    password: userpassword
...
```

## Основные модули

### sw.py

> Используется для подключения к коммутаторам и работы с ними

Можно запускать как отдельный скрипт, так и импортировать классы и функции.

```shell
$ ./sw.py IP COMMAND
```

#### IP

ip-адрес коммутатора, поддерживается сокращенный формат `x.x`, в этом случае подразумевается `192.168.x.x`. Практически все консольные утилиты из данного репозитория поддерживают как полный, так и сокращенный формат записи ip.

#### COMMAND

##### show

Выводит краткую информацию о коммутаторе в виде строки формата:
```
model [short_ip] location [--full]
```
Расположение коммутатора будет выделено цветом:
- **зеленый** - обычные коммутаторы доступа
- **ярко-красный** - центральные свитчи
- **ярко-желтый** - узловые свитчи с маршрутизацией
- **ярко-зеленый** - узловые расширители портов 1G
- **ярко-синий** - узловые расширители портов 10G
- **ярко-голубой** - GPON на АТС
- **бледно-синий** - узловые расширители портов 10G с урезанной CLI
- **серый** - GPON на Осипенко, Huawey на АТС, доступа к CLI нет

Если указан флаг `--full`, второй строчкой выводится mac-адрес устройства.

##### connect

Подключается к коммутатору через `telnet` и передает управление пользователю. Стандартное приветствие коммутатора заменяется короткой строкой, генерируемой описанной выше командой `show`. Заголовок окна также меняется на `[short_ip] location`

##### send

Отправляет одну или несколько команд на коммутатор, возвращает результат выполнения команд. Команды можно разделять либо символом ';', либо новой строкой. Пустые строки и отступы при этом игнорируются.

### db.py

> Используется для работы с локальной базой данных коммутаторов

Можно запускать как отдельный скрипт, так и импортировать классы и функции. Данные хранятся в директории `data`. Используется база данных `SQLite`.

#### Генерация актуальной базы данных

```shell
$ ./db.py generate
```
В этом режиме из базы удаляются все старые записи, далее проверяются все возможные адреса коммутаторов и добавляются те, которые доступны на данный момент. Вся процедура на текущей сети ИНКО занимает около 2 минут из-за таймаутов ожидания недоступных коммутаторов. 

#### Вывод списка ip

```shell
$ ./db.py list
```
Выводит список всех ip адресов и общее количество записей в базе данных.

#### Работа с конкретным ip

```shell
$ ./db.py add IP
$ ./db.py get IP
$ ./db.py delete IP
```
Добавление коммутатора в базу, просмотр информации из базы, удаление коммутатора.

#### Поиск по базе

```shell
$ ./db.py search STRING
```

Выполняет поиск в названии модели или адресе установки коммутатора.


### wsgi.py

> api модуль для работы с локальной базой данных

- **'/'**, `GET` - получение списка всех ip адресов коммутаторов из базы в формате json

- **'/<ip address>'**, `GET`, `POST`, `DELETE` - просмотр, добавление, удаление коммутатора, никаких параметров передавать не нужно

## Примеры использования

### Быстрое подключение к коммутаторам

Добавляем простую функцию-алиас в `.bashrc` или `.zshrc`:

```sh
tt () {
    cur_dir=$(pwd)
    cd ~/scripts-python
    source .venv/bin/activate
    python sw.py $@ connect
    deactivate
    cd $cur_dir
}
```

Подключаемся к коммуторам командой:
```shell
$ tt 59.75
```

### Вывод всех коммутаторов qtech

```shell
$ ./db.py search qsw
```

### Отправка команд и вывод результата

```shell
$ ./sw.py 59.75 send "sh ports 1; conf ports 1 st d; sh ports 1; conf ports 1 st e"
$ ./sw.py 58.236 send "sh run int eth 1/2; conf t; int eth 1/2; no shut; end; sh run int eth 1/2; conf t; int eth 1/2; shut;"
$ ./sw.py 59.75 send "sh vlan
dquote> create vlan 666 tag 666; conf vlan 66 add tag 1
dquote> sh vlan"
```
